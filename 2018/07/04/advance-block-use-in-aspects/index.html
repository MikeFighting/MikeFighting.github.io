<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.0.3" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/mike_apple-touch-icon.png?v=6.0.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/mike32x32.png?v=6.0.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/mike16x16.png?v=6.0.3">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.3" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.0.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="Objective-C,">


<meta name="description" content="前言Block算是OC语言中比较经典的语法，对其讲解的文章也不少，但大多讲的是其实现原理，而没有将其原理应用于实际中。本文将从实践出发，从Aspects框架中分析Block的本质，以及如何从Block中获取方法签名和参数列表。在分析之前我们先来看下Aspects为什么要使用Block来实现。 Aspects为什么要使用Block？我们知道在objc中使用MethodSwizzle来实现AOP是很简">
<meta name="keywords" content="Objective-C">
<meta property="og:type" content="article">
<meta property="og:title" content="Aspects框架中Block的使用">
<meta property="og:url" content="https://mikefighting.github.io/2018/07/04/advance-block-use-in-aspects/index.html">
<meta property="og:site_name" content="击水湘江">
<meta property="og:description" content="前言Block算是OC语言中比较经典的语法，对其讲解的文章也不少，但大多讲的是其实现原理，而没有将其原理应用于实际中。本文将从实践出发，从Aspects框架中分析Block的本质，以及如何从Block中获取方法签名和参数列表。在分析之前我们先来看下Aspects为什么要使用Block来实现。 Aspects为什么要使用Block？我们知道在objc中使用MethodSwizzle来实现AOP是很简">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2018-12-24T08:32:39.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Aspects框架中Block的使用">
<meta name="twitter:description" content="前言Block算是OC语言中比较经典的语法，对其讲解的文章也不少，但大多讲的是其实现原理，而没有将其原理应用于实际中。本文将从实践出发，从Aspects框架中分析Block的本质，以及如何从Block中获取方法签名和参数列表。在分析之前我们先来看下Aspects为什么要使用Block来实现。 Aspects为什么要使用Block？我们知道在objc中使用MethodSwizzle来实现AOP是很简">






  <link rel="canonical" href="https://mikefighting.github.io/2018/07/04/advance-block-use-in-aspects/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>
  <title>Aspects框架中Block的使用 | 击水湘江</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">击水湘江</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Born To Fight!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://mikefighting.github.io/2018/07/04/advance-block-use-in-aspects/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="击水湘江">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="击水湘江">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Aspects框架中Block的使用</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-04T17:41:04+08:00">2018-07-04</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Block算是OC语言中比较经典的语法，对其讲解的文章也不少，但大多讲的是其实现原理，而没有将其原理应用于实际中。本文将从实践出发，从Aspects框架中分析Block的本质，以及如何从Block中获取方法签名和参数列表。在分析之前我们先来看下Aspects为什么要使用Block来实现。</p>
<h2 id="Aspects为什么要使用Block？"><a href="#Aspects为什么要使用Block？" class="headerlink" title="Aspects为什么要使用Block？"></a>Aspects为什么要使用Block？</h2><p>我们知道在objc中使用MethodSwizzle来实现AOP是很简单的，具体做法可以参考这两篇：<a href="https://blog.csdn.net/erice_e/article/details/73293905" target="_blank" rel="noopener">method-swizzling 详解和使用</a>，<a href="https://blog.csdn.net/yiyaaixuexi/article/details/9374411" target="_blank" rel="noopener">Objective-C的hook方案</a>文中讲解了怎样在方法中注入相应的代码，但是这样做有以下两个问题：</p>
<ol>
<li>需要为每个被Hook的类新建一个分类。</li>
<li>对于每一个需要Hook的方法，我们都需要重写一个和它参数列表一样的方法。</li>
</ol>
<p>这些问题就会让AOP变得复杂，并且Hook方法不能统一添加。比如有这样一个需求：一个数组，数组里面配置了每个类需要Hook的N个方法，这些方法中需要注入相同的代码。这时总不能给每个类都添加一个方法，然后在里面新加一段统一的代码吧？怎样做才更优雅呢？更好的方法是将需要注入或新加的方法实现写在Block中，使用这个Block作为上文中提到的被插入的方法，这样就避免创建一个分类文件，同时再对原方法写一个相同参数的方法。但是使用Block又有以下两个问题：</p>
<ol>
<li>因为MethodSwizzle最终切换的是方法，而我们写的是Block，Block怎样和方法之间产生关联？</li>
<li>如何获取Bolck的参数列表以便给它传递原方法相应的形参？</li>
</ol>
<p>对于第一问题，Aspects框架是这样做的：</p>
<ol>
<li>获取Block的方法签名。</li>
<li>调用<code>class_replaceMethod</code>替换掉需要被Hook的方法。</li>
<li>调用<code>class_replaceMethod</code>替换掉系统</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>在自己的<code>forwardInvocation:</code>方法中，利用1中获取的方法签名来生成新的NSInvocation，利用NSInvocation调用Block。</li>
</ol>
<p>这样问题的关键就在于获取Block的方法签名了。</p>
<h2 id="获取Block的Signature"><a href="#获取Block的Signature" class="headerlink" title="获取Block的Signature"></a>获取Block的Signature</h2><p>怎样从block中获取其方法签名呢？我们从Block的语法中是得不到任何信息的。只有看看编译器对我们的Block语法做了哪些“手脚”才可以看到，Block编译后的代码在<a href="https://github.com/llvm-mirror/compiler-rt/blob/master/lib/BlocksRuntime/Block_private.h" target="_blank" rel="noopener">苹果开源的LLVM镜像中有提及</a>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">    BLOCK_REFCOUNT_MASK =     (<span class="number">0xffff</span>),</span><br><span class="line">    BLOCK_NEEDS_FREE =        (<span class="number">1</span> &lt;&lt; <span class="number">24</span>),</span><br><span class="line">    BLOCK_HAS_COPY_DISPOSE =  (<span class="number">1</span> &lt;&lt; <span class="number">25</span>),</span><br><span class="line">    BLOCK_HAS_CTOR =          (<span class="number">1</span> &lt;&lt; <span class="number">26</span>), <span class="comment">/* Helpers have C++ code. */</span></span><br><span class="line">    BLOCK_IS_GC =             (<span class="number">1</span> &lt;&lt; <span class="number">27</span>),</span><br><span class="line">    BLOCK_IS_GLOBAL =         (<span class="number">1</span> &lt;&lt; <span class="number">28</span>),</span><br><span class="line">    BLOCK_HAS_DESCRIPTOR =    (<span class="number">1</span> &lt;&lt; <span class="number">29</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Revised new layout. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Block_descriptor</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> reserved;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">void</span> (*copy)(<span class="keyword">void</span> *dst, <span class="keyword">void</span> *src);</span><br><span class="line">    <span class="keyword">void</span> (*dispose)(<span class="keyword">void</span> *);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Block_layout</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *isa;</span><br><span class="line">    <span class="keyword">int</span> flags;</span><br><span class="line">    <span class="keyword">int</span> reserved;</span><br><span class="line">    <span class="keyword">void</span> (*invoke)(<span class="keyword">void</span> *, ...);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Block_descriptor</span> *<span class="title">descriptor</span>;</span></span><br><span class="line">    <span class="comment">/* Imported variables. */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>从中我们可以看出<code>Block</code>其实是一个对象，我们来分析下这个对象：</p>
<h3 id="void-isa-指向该Block所属类的指针"><a href="#void-isa-指向该Block所属类的指针" class="headerlink" title="void *isa:指向该Block所属类的指针"></a>void *isa:指向该Block所属类的指针</h3><p>在Block中，这个指针可能的值为：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> _NSConcreteStackBlock</span><br><span class="line"><span class="number">2.</span> _NSConcreteGlobalBlock</span><br><span class="line"><span class="number">3.</span> _NSConcreteMallocBlock</span><br><span class="line"><span class="number">4.</span> _NSConcreteAutoBlock</span><br><span class="line"><span class="number">5.</span> _NSConcreteFinalizingBlock</span><br></pre></td></tr></table></figure>

<p>这五种类型的Block都继承自<code>_NSAbstractBlock</code>。其具体的类型是根据Block创建的位置决定的，如果Block被定义在一个方法中做为一个局部变量，则其创建出来为<code>_NSConcreteStackBlock</code>（如果我们调用<code>copy</code>方法将其复制到上时，其类型将变为<code>_NSConcreteMallocBlock</code>），如果定义为全局变量，那么它就是<code>_NSConcreteGlobalBlock</code>。至于什么场景会产生什么Block对象不在本文的讨论范围，可以从本文的参考资料中获取。</p>
<h3 id="int-flags-Block属性的标识符"><a href="#int-flags-Block属性的标识符" class="headerlink" title="int flags: Block属性的标识符"></a>int flags: Block属性的标识符</h3><p>我们可以通过该属性来对Block是否含有某种信息做以判断，我们来详细说明这些标识符：</p>
<ul>
<li><code>BLOCK_REFCOUNT_MASK，BLOCK_NEEDS_FREE，BLOCK_IS_GC</code>：这三个与引用计数和GC相关的标识符是在运行时，当Block被拷贝时设定的。</li>
<li><code>BLOCK_IS_GLOBAL</code>：对于全局存储的Block，这个属性是在编译期被设定的，对这种类型的Block执行Copy和Releas是不起作用的，因为它存储在应用程序的数据区。</li>
<li><code>BLOCK_HAS_DESCRIPTOR</code>：这个标示总是会被设置，因为在Mac OS的Snow Leopard版本前后Block的实现是不同的，为了区分之后的实现，所以总是要被设置。</li>
<li><code>BLOCK_HAS_COPY_DISPOSE</code>：如果Block捕获了某个变量，那么就需要将实现copy和dispose方法，这时就会设置该位。</li>
<li><code>BLOCK_HAS_CTOR</code>：如果Block中含有C++的构造解释器，那么就会设置该位。</li>
</ul>
<h3 id="void-invoke-void-…-函数指针"><a href="#void-invoke-void-…-函数指针" class="headerlink" title="void (*invoke)(void *, …): 函数指针"></a>void (*invoke)(void *, …): 函数指针</h3><p>这个指针就是我们写Block时候的实现，编译器会给我们创建一个C语言的函数，这个函数的指针被赋值给invoke指针。这时我们就可以通过函数调用来调用Block中函数的实现，请看下文的使用函数指针调用Block。</p>
<h3 id="struct-Block-descriptor-descriptor：Block的描述信息"><a href="#struct-Block-descriptor-descriptor：Block的描述信息" class="headerlink" title="struct Block_descriptor *descriptor：Block的描述信息"></a>struct Block_descriptor *descriptor：Block的描述信息</h3><p>这个结构体里面保存着Block的大小：<code>size</code>，Block捕获<code>__block</code>类型变量被Copy时调用的<code>void (*copy)(void *dst, const void *src);</code>以及被销毁时候调用的<code>void (*dispose)(void *);</code>方法。</p>
<p>这些Block的基本知识了解之后，我们看本小节的主旨：如何通过Block获取方法的签名？其实在上面官方提供的文档中看，早期的Block实现中没有提供方法签名，后来在<code>flags</code>的枚举中又新加了一个<code>BLOCK_HAS_SIGNATURE = (1 &lt;&lt; 30)</code>这个枚举项，通过对这个枚举项的判断我们可以确定一个Block中是否含有方法的签名。方法签名的标识有了，那么这个方法签名存放在哪里呢？它存放在<code>Block_descriptor</code>结构体中<code>dispose</code>下面，我们来看Aspects框架是怎样将Block转换为方法签名的：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Block internals.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_OPTIONS</span>(<span class="keyword">int</span>, AspectBlockFlags) &#123;</span><br><span class="line">    AspectBlockFlagsHasCopyDisposeHelpers = (<span class="number">1</span> &lt;&lt; <span class="number">25</span>),</span><br><span class="line">    AspectBlockFlagsHasSignature          = (<span class="number">1</span> &lt;&lt; <span class="number">30</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _AspectBlock &#123;</span><br><span class="line">    __unused Class isa;</span><br><span class="line">    AspectBlockFlags flags;</span><br><span class="line">    __unused <span class="keyword">int</span> reserved;</span><br><span class="line"><span class="keyword">void</span> (__unused *invoke)(<span class="keyword">struct</span> _AspectBlock *block, ...);</span><br><span class="line"><span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> reserved;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="comment">// requires AspectBlockFlagsHasCopyDisposeHelpers</span></span><br><span class="line">    <span class="keyword">void</span> (*<span class="keyword">copy</span>)(<span class="keyword">void</span> *dst, <span class="keyword">const</span> <span class="keyword">void</span> *src);</span><br><span class="line">    <span class="keyword">void</span> (*dispose)(<span class="keyword">const</span> <span class="keyword">void</span> *);</span><br><span class="line">    <span class="comment">// requires AspectBlockFlagsHasSignature</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *signature;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *layout;</span><br><span class="line">&#125; *descriptor;</span><br><span class="line"><span class="comment">// imported variables</span></span><br><span class="line">&#125; *AspectBlockRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSMethodSignature</span> *aspect_blockMethodSignature(<span class="keyword">id</span> block, <span class="built_in">NSError</span> **error) &#123;</span><br><span class="line">    AspectBlockRef layout = (__bridge <span class="keyword">void</span> *)block;</span><br><span class="line"><span class="keyword">if</span> (!(layout-&gt;flags &amp; AspectBlockFlagsHasSignature)) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *description = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"The block %@ doesn't contain a type signature."</span>, block];</span><br><span class="line">        AspectError(AspectErrorMissingBlockSignature, description);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> *desc = layout-&gt;descriptor;</span><br><span class="line">    desc += <span class="number">2</span> * <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span>);</span><br><span class="line">    <span class="keyword">if</span> (layout-&gt;flags &amp; AspectBlockFlagsHasCopyDisposeHelpers) &#123;</span><br><span class="line">    desc += <span class="number">2</span> * <span class="keyword">sizeof</span>(<span class="keyword">void</span> *);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">if</span> (!desc) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *description = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"The block %@ doesn't has a type signature."</span>, block];</span><br><span class="line">        AspectError(AspectErrorMissingBlockSignature, description);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *signature = (*(<span class="keyword">const</span> <span class="keyword">char</span> **)desc);</span><br><span class="line"><span class="keyword">return</span> [<span class="built_in">NSMethodSignature</span> signatureWithObjCTypes:signature];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从中我们可以看出首先判断是否含有方法签名，如果没有则直接返回，如果有则通过指针的移动来指向方法签名所在的位置，并调用<code>[NSMethodSignature signatureWithObjCTypes:signature];</code>来生成方法签名。</p>
<h2 id="获取Block的参数列表"><a href="#获取Block的参数列表" class="headerlink" title="获取Block的参数列表"></a>获取Block的参数列表</h2><p>有了方法签名之后获取参数列表是相对简单的，其关键代码如下所示：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">BOOL</span> aspect_isCompatibleBlockSignature(<span class="built_in">NSMethodSignature</span> *blockSignature, <span class="keyword">id</span> object, SEL selector, <span class="built_in">NSError</span> **error) &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="built_in">BOOL</span> signaturesMatch = <span class="literal">YES</span>;</span><br><span class="line">    <span class="built_in">NSMethodSignature</span> *methodSignature = [[object <span class="keyword">class</span>] instanceMethodSignatureForSelector:selector];</span><br><span class="line">    <span class="keyword">if</span> (blockSignature.numberOfArguments &gt; methodSignature.numberOfArguments) &#123;</span><br><span class="line">        signaturesMatch = <span class="literal">NO</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (blockSignature.numberOfArguments &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *blockType = [blockSignature getArgumentTypeAtIndex:<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (blockType[<span class="number">0</span>] != <span class="string">'@'</span>) &#123;</span><br><span class="line">                signaturesMatch = <span class="literal">NO</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Argument 0 is self/block, argument 1 is SEL or id&lt;AspectInfo&gt;. We start comparing at argument 2.</span></span><br><span class="line">        <span class="comment">// The block can have less arguments than the method, that's ok.</span></span><br><span class="line">        <span class="comment">// 这里获取Block中的参数列表以便和原方法的参数列表进行比较，看其是否匹配</span></span><br><span class="line">        <span class="keyword">if</span> (signaturesMatch) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> idx = <span class="number">2</span>; idx &lt; blockSignature.numberOfArguments; idx++) &#123;</span><br><span class="line">                <span class="keyword">const</span> <span class="keyword">char</span> *methodType = [methodSignature getArgumentTypeAtIndex:idx];</span><br><span class="line">                <span class="keyword">const</span> <span class="keyword">char</span> *blockType = [blockSignature getArgumentTypeAtIndex:idx];</span><br><span class="line">                <span class="comment">// Only compare parameter, not the optional type data.</span></span><br><span class="line">                <span class="keyword">if</span> (!methodType || !blockType || methodType[<span class="number">0</span>] != blockType[<span class="number">0</span>]) &#123;</span><br><span class="line">                    signaturesMatch = <span class="literal">NO</span>; </span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!signaturesMatch) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要做了原始方法和新方法之间参数的比较，如果参数不对应则注入方法之后再重新调用原始方法时会出错，所以这里获取了Block的参数列表。主要用到的是NSMethodSignature的两个方法:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">NSUInteger</span> numberOfArguments;</span><br><span class="line">- (<span class="keyword">const</span> <span class="keyword">char</span> *)getArgumentTypeAtIndex:(<span class="built_in">NSUInteger</span>)idx <span class="built_in">NS_RETURNS_INNER_POINTER</span>;</span><br></pre></td></tr></table></figure>

<h2 id="使用函数指针调用Block"><a href="#使用函数指针调用Block" class="headerlink" title="使用函数指针调用Block"></a>使用函数指针调用Block</h2><p>我们可以通过定义自己的Block结构体，然后将Block变量强制转化，之后调用上文中提到的<code>invoke</code>函数指针来实现对Block结构体的调用，运行下面的代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> MyBlockDescriptor &#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> reserved;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">void</span> (*<span class="keyword">copy</span>)(<span class="keyword">void</span> *dst, <span class="keyword">const</span> <span class="keyword">void</span> *src);</span><br><span class="line">    <span class="keyword">void</span> (*dispose)(<span class="keyword">const</span> <span class="keyword">void</span> *);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> MyBlockLayout &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *isa;</span><br><span class="line">    <span class="keyword">int</span> flags;</span><br><span class="line">    <span class="keyword">int</span> reserved;</span><br><span class="line">    <span class="keyword">void</span> (* invoke)(<span class="keyword">void</span> *, ...);</span><br><span class="line">    <span class="keyword">struct</span> MyBlockDescriptor *descripter;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)callBlockByFuncPointer &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//简单Block的调用</span></span><br><span class="line">    <span class="keyword">void</span> (^block)() = ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Block called"</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">struct</span> MyBlockLayout *block1 = (<span class="keyword">struct</span> MyBlockLayout *)(__bridge <span class="keyword">void</span> *)block;</span><br><span class="line">    block1-&gt;invoke(block1);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//含有参数的Block调用</span></span><br><span class="line">    <span class="keyword">int</span> (^returnBlock)(<span class="keyword">int</span>, <span class="keyword">int</span> ) = ^<span class="keyword">int</span>(<span class="keyword">int</span> a, <span class="keyword">int</span> b) &#123;</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> MyBlockLayout *block2 = (<span class="keyword">struct</span> MyBlockLayout *)(__bridge <span class="keyword">void</span> *)returnBlock;</span><br><span class="line">    <span class="comment">//这是将void * 指针转换为 (int (*)(void *, int a, ...))类型的指针</span></span><br><span class="line">    <span class="keyword">int</span> result = (  (<span class="keyword">int</span> (*)(<span class="keyword">void</span> *, <span class="keyword">int</span> a, ...)) (block2-&gt;invoke)  ) (block2, <span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"result == %d"</span>,result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们将Block强制转换为我们自定义的<code>MyBlockLayout</code>，然后将<code>void *</code>类型的指针转换为Block相应实现的指针，这时候就可以实现以函数指针的形式调用Block了。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本文小结了Block的本质，以及如何利用自定义的Block结构体，通过桥接将系统的Block转化成我们的Block结构体，从而获取其函数指针和方法签名。同时说明了标示block特性的flags，这个标示在使用Block结构体的时候往往很有用。其实FaceBook开源的框架：FBRetainCycleDetector中用到了相似的手段，感兴趣的可以对比看下。</p>
<h2 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h2><p>Objective-C高级编程<br><a href="https://stackoverflow.com/questions/13006685/is-there-a-way-to-wrap-an-objectivec-block-into-function-pointer?utm_medium=organic&amp;utm_source=google_rich_qa&amp;utm_campaign=google_rich_qa" target="_blank" rel="noopener">https://stackoverflow.com/questions/13006685/is-there-a-way-to-wrap-an-objectivec-block-into-function-pointer?utm_medium=organic&amp;utm_source=google_rich_qa&amp;utm_campaign=google_rich_qa</a><br><br><a href="http://www.galloway.me.uk/2013/05/a-look-inside-blocks-episode-3-block-copy/" target="_blank" rel="noopener">http://www.galloway.me.uk/2013/05/a-look-inside-blocks-episode-3-block-copy/</a><br><br>Advanced Mac OS X Programming: The Big Nerd Ranch Guide<br><br><a href="http://www.galloway.me.uk/2012/10/a-look-inside-blocks-episode-1/" target="_blank" rel="noopener">http://www.galloway.me.uk/2012/10/a-look-inside-blocks-episode-1/</a> <br><br><a href="http://blog.devtang.com/2013/07/28/a-look-inside-blocks/" target="_blank" rel="noopener">http://blog.devtang.com/2013/07/28/a-look-inside-blocks/</a><br><br><a href="https://github.com/llvm-mirror/compiler-rt/blob/master/lib/BlocksRuntime/Block_private.h" target="_blank" rel="noopener">https://github.com/llvm-mirror/compiler-rt/blob/master/lib/BlocksRuntime/Block_private.h</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Objective-C/" rel="tag"># Objective-C</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/06/05/oc-think-in-aop/" rel="next" title="AOP实践小结">
                <i class="fa fa-chevron-left"></i> AOP实践小结
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08/02/rm-rf-lsof-recover/" rel="prev" title="执行rm -rf后的一种恢复方案">
                执行rm -rf后的一种恢复方案 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="击水湘江">
            
              <p class="site-author-name" itemprop="name">击水湘江</p>
              <p class="site-description motion-element" itemprop="description">努力让明天的自己爱上今天的自己！</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">56</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">10</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Aspects为什么要使用Block？"><span class="nav-number">2.</span> <span class="nav-text">Aspects为什么要使用Block？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#获取Block的Signature"><span class="nav-number">3.</span> <span class="nav-text">获取Block的Signature</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#void-isa-指向该Block所属类的指针"><span class="nav-number">3.1.</span> <span class="nav-text">void *isa:指向该Block所属类的指针</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#int-flags-Block属性的标识符"><span class="nav-number">3.2.</span> <span class="nav-text">int flags: Block属性的标识符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#void-invoke-void-…-函数指针"><span class="nav-number">3.3.</span> <span class="nav-text">void (*invoke)(void *, …): 函数指针</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#struct-Block-descriptor-descriptor：Block的描述信息"><span class="nav-number">3.4.</span> <span class="nav-text">struct Block_descriptor *descriptor：Block的描述信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#获取Block的参数列表"><span class="nav-number">4.</span> <span class="nav-text">获取Block的参数列表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用函数指针调用Block"><span class="nav-number">5.</span> <span class="nav-text">使用函数指针调用Block</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小结"><span class="nav-number">6.</span> <span class="nav-text">小结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料："><span class="nav-number">7.</span> <span class="nav-text">参考资料：</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">击水湘江</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Muse</a> v6.0.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.3"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
